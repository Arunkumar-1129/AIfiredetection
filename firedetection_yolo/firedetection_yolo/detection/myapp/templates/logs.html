{% extends 'base.html' %}

{% block title %}Detection Logs - Fire Detection System{% endblock %}

{% block content %}
<style>
    .logs-container {
        animation: fadeInUp 0.5s ease-in-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .filter-group {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    
    .filter-group .form-select,
    .filter-group .form-control {
        flex: 1;
        min-width: 150px;
    }
    
    .filter-group .btn {
        white-space: nowrap;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        margin: 20px 0;
    }
    
    .table thead th {
        text-align: center;
        vertical-align: middle;
        font-weight: 600;
        border: none;
        padding: 12px 8px !important;
    }
    
    .table tbody td {
        vertical-align: middle;
        text-align: center;
        padding: 12px 8px !important;
    }
    
    .table tbody td:first-child {
        text-align: left;
    }   
    
    .progress {
        min-width: 100px;
        margin: 0 auto;
    }
    
    .btn-group {
        display: flex;
        justify-content: center;
        gap: 6px;
    }
</style>

<div class="logs-container">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-list"></i> Detection History</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportLogs()">
                            <i class="fas fa-download"></i> Export as PDF
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearLogs()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                {% comment %} <div class="card-body">
                    <!-- Filter Controls -->
                    <div class="filter-group mb-3">
                        <label class="form-label mb-0 me-2" style="min-width: 60px;">Filters:</label>
                        <select class="form-select" id="typeFilter">
                            <option value="">All Types</option>
                            <option value="fire">Fire Only</option>
                            <option value="smoke">Smoke Only</option>
                        </select>
                        <input type="date" class="form-control" id="dateFilter">
                        {% comment %} <select class="form-select" id="confidenceFilter">
                            <option value="">All Confidence</option>
                            <option value="high">High (>70%)</option>
                            <option value="medium">Medium (30-70%)</option>
                        </select> {% endcomment %}
                        {% comment %} <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div> {% endcomment %} 
                <!-- Logs Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th style="text-align: left;">ID</th>
                                <th>Type</th>
                                <th>Confidence</th>
                                <th>Date & Time</th>
                                <th>Alert Sent</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            {% for log in logs %}
                            <tr data-type="{{ log.detection_type }}" data-confidence="{{ log.confidence }}" data-date="{{ log.detected_at|date:'Y-m-d' }}">
                                <td style="text-align: left;">{{ log.id }}</td>
                                <td>
                                    <span class="badge bg-{% if log.detection_type == 'fire' %}danger{% elif log.detection_type == 'smoke' %}warning{% else %}info{% endif %}">
                                        <i class="fas fa-{% if log.detection_type == 'fire' %}fire{% elif log.detection_type == 'smoke' %}cloud{% else %}exclamation{% endif %}"></i>
                                        {{ log.get_detection_type_display }}
                                    </span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px; margin: 0 auto; width: 120px;">
                                        <div class="progress-bar bg-{% if log.confidence > 0.7 %}success{% elif log.confidence > 0.5 %}warning{% else %}danger{% endif %}" 
                                             style="width: {{ log.confidence|floatformat:0 }}%">
                                            {{ log.confidence|floatformat:1 }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <small>
                                        {{ log.detected_at|date:"M d, Y" }}<br>
                                        {{ log.detected_at|date:"H:i:s" }}
                                    </small>
                                </td>
                                <td>
                                    {% if log.alert_sent %}
                                        <span class="text-success" style="font-size: 1.3rem;">✅</span>
                                    {% else %}
                                        <span class="text-muted">❌</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                    No detection logs found
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% comment %} <!-- Pagination would go here in a real implementation -->
                <nav aria-label="Logs pagination" class="d-flex justify-content-center">
                    <ul class="pagination">
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">1</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    </ul>
                </nav> {% endcomment %}
            </div>
        </div>
    </div>

    {% comment %} <!-- Statistics Summary -->
    <div class="row g-3 mt-2">
        <div class="col-md-4 col-sm-6">
            <div class="card h-100 text-center">
                <div class="card-body d-flex flex-column justify-content-center">
                    <h3 class="text-danger mb-2">{{ logs|length }}</h3>
                    <p class="mb-0">Total Logs</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card h-100 text-center">
                <div class="card-body d-flex flex-column justify-content-center">
                    <h3 class="text-warning mb-2">
                        {% with fire_logs=logs|dictsort:"detection_type" %}
                            {{ fire_logs|length }}
                        {% endwith %}
                    </h3>
                    <p class="mb-0">High Confidence</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card h-100 text-center">
                <div class="card-body d-flex flex-column justify-content-center">
                    <h3 class="text-success mb-2">
                        {% now "Y-m-d" as today %}
                        {{ logs|length }}
                    </h3>
                    <p class="mb-0">Today's Detections</p>
                </div>
            </div>
        </div>
    </div>
</div> {% endcomment %}

{% comment %} <!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detection Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="img-fluid" alt="Detection Image">
            </div>
        </div>
    </div>
</div> {% endcomment %}
{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
    const typeFilter = document.getElementById('typeFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const confidenceFilter = document.getElementById('confidenceFilter').value;
    
    const rows = document.querySelectorAll('#logsTableBody tr');
    
    rows.forEach(row => {
        let show = true;
        
        // Type filter
        if (typeFilter && row.dataset.type !== typeFilter) {
            show = false;
        }
        
        // Date filter
        if (dateFilter && row.dataset.date !== dateFilter) {
            show = false;
        }
        
        // Confidence filter
        if (confidenceFilter) {
            const confidence = parseFloat(row.dataset.confidence);
            if (confidenceFilter === 'high' && confidence <= 0.7) {
                show = false;
            } else if (confidenceFilter === 'medium' && (confidence <= 0.3 || confidence > 0.7)) {
                show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function viewImage(imagePath) {
    document.getElementById('modalImage').src = '/media/' + imagePath;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function viewDetails(logId) {
    alert('View details for log ID: ' + logId);
    // In real implementation, show detailed modal
}

function deleteLog(logId) {
    if (confirm('Are you sure you want to delete this log?')) {
        // In real implementation, make AJAX call to delete
        alert('Log ' + logId + ' would be deleted');
    }
}

function exportLogs() {
    // Redirect to PDF export endpoint
    window.location.href = '/logs/export-pdf/';
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
        // In real implementation, make AJAX call to clear all logs
        alert('All logs would be cleared');
    }
}

// Set today's date as default for date filter
document.getElementById('dateFilter').valueAsDate = new Date();
</script>
{% endblock %}